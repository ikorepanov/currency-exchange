# Currency Exchange

Backend-сервис для управления валютными данными и автоматизации обмена. API предоставляет интерфейс для ведения справочника валют, актуализации курсов и выполнения моментального пересчета сумм. Взаимодействие построено на обмене JSON-сообщениями через стандартные HTTP-методы.

---

## О проекте

Проект демонстрирует реализацию RESTful-сервиса без использования сторонних веб-фреймворков. Основной акцент сделан на чистой архитектуре (MVC), строгой типизации данных и прямой работе с реляционной базой данных через параметризованные SQL-запросы.

---

## Функциональность

Проект реализует следующие возможности:

- **Управление списком валют:**
  - просмотр всех валют и отдельных валют по коду;
  - добавление новых валют в базу данных.

- **Управление обменными курсами:**
  - просмотр всех курсов и конкретной валютной пары;
  - добавление и обновление курсов обмена.

- **Конвертация валют:**
  - вычисление суммы в целевой валюте по имеющимся курсам;
  - интеллектуальный расчет: алгоритм автоматически вычисляет итоговую сумму, даже если прямая валютная пара отсутствует в базе, используя обратные котировки или промежуточный пересчет через USD.

- **Обработка ошибок с корректными HTTP-кодами:**
  - `200` — успешные запросы GET/PATCH;
  - `201` — успешное создание ресурса POST;
  - `400` — некорректные параметры запроса;
  - `404` — ресурс не найден;
  - `409` — конфликт уникальности;
  - `500` — внутренние ошибки сервера.

---

## Архитектура

### Модели данных

**Currencies**

- `ID` — первичный ключ, автоинкремент
- `Code` — уникальный код валюты
- `FullName` — полное название валюты
- `Sign` — символ валюты

**ExchangeRates**

- `ID` — первичный ключ, автоинкремент
- `BaseCurrencyId` — ссылка на `Currencies.ID` базовой валюты
- `TargetCurrencyId` — ссылка на `Currencies.ID` целевой валюты
- `Rate` — курс обмена (NUMERIC. Округление до 6 знаков выполняется на уровне приложения)

### Слои приложения

- **Controller** — обработка HTTP-запросов, валидация данных, формирование JSON-ответов, обработка ошибок от нижележащих слоёв.
- **Service** — центральный узел бизнес-логики. Здесь инкапсулированы алгоритмы многошаговой конвертации и координация работы между репозиториями. Подготавливает данные в формате DTO.
- **Repository** — преобразование результатов DAO в модели и предоставление их для сервисного слоя.
- **DAO** — доступ к базе данных, параметризованные SQL-запросы.

---

## Особенности реализации

- **Валидация кода валюты**
  - код должен состоять ровно из **3 заглавных английских букв** (`USD`, `EUR`, `RUB`);
  - некорректные значения приводят к ответу `400 Bad Request`.

- **Валидация символа валюты (`sign`)**
  - знак валюты должен быть **одним Unicode-символом** категории `Currency_Symbol` (`Sc`);
  - примеры допустимых символов: `$`, `€`, `£`, `₽`;
  - некорректные значения приводят к ответу `400 Bad Request`.

- **Сериализация DTO в JSON**
  - ответы API формируются из DTO-объектов и автоматически преобразуются в JSON;
  - ключи в ответах приводятся к формату **lowerCamelCase**  
    (например, `converted_amount` → `convertedAmount`).

- **Округление Decimal в JSON**
  - Все значения Decimal в JSON округляются до 2 знаков после запятой.

---

## REST API

### Валюты

- `GET /currencies` — список всех валют
- `GET /currency/{code}` — получение валюты по коду: код валюты - в адресе запроса
- `POST /currencies` — регистрация новой валюты. Параметры принимаются в формате `x-www-form-urlencoded`: `name`, `code`, `sign`.

### Курсы обмена

- `GET /exchangeRates` — список всех обменных курсов
- `GET /exchangeRate/{pair}` — получение обменного курса конкретной пары валют: валютная пара - в адресе запроса это коды валют, идущие друг за другом без разделителя
- `POST /exchangeRates` — регистрация нового обменного курса. Параметры принимаются в формате `x-www-form-urlencoded`: `baseCurrencyCode`, `targetCurrencyCode`, `rate`
- `PATCH /exchangeRate/{pair}` — обновление существующего обменного курса: валютная пара - в адресе запроса это коды валют, идущие друг за другом без разделителя. Параметры принимаются в формате `x-www-form-urlencoded`: `rate`

### Конвертация валют

- `GET /exchange?from=BASE&to=TARGET&amount=AMOUNT` — расчет суммы в целевой валюте (`TARGET`) для перевода указанного количества средств (`AMOUNT`) из исходной валюты (`BASE`) по текущему курсу  
  Поддерживаются:
  - прямой курс;
  - обратный курс;
  - кросс-курс через USD.

### Пример ответа на конвертацию

```json
{
  "baseCurrency": {
    "id": 0, 
    "name": "US dollar",
    "code": "USD",
    "sign": "$" 
  },
  "targetCurrency": {
    "id": 1,
    "name": "Russian ruble",
    "code": "RUB",
    "sign": "₽" 
  },
  "rate": 78.00,
  "amount": 10.00,
  "convertedAmount": 780.00
}
```

---

## Примеры запросов (cURL)

Ниже приведены примеры команд для проверки API через терминал.

### Валюты
- **Список всех валют:**
    ```sh
    curl -X GET http://localhost:8000/currencies
    ```
- **Получить валюту по коду:**
    ```sh
    curl -X GET http://localhost:8000/currency/EUR
    ```
- **Добавить новую валюту:**
    ```sh
    curl -X POST http://localhost:8000/currencies \
         -H "Content-Type: application/x-www-form-urlencoded" \
         -d "name=British Pound" -d "code=GBP" -d "sign=£"
    ```

### Обменные курсы
- **Список всех курсов:**
    ```sh
    curl -X GET http://localhost:8000/exchangeRates
    ```
- **Получить курс конкретной пары:**
    ```sh
    curl -X GET http://localhost:8000/exchangeRate/USDRUB
    ```
- **Добавить новый курс:**
    ```sh
    curl -X POST http://localhost:8000/exchangeRates \
         -H "Content-Type: application/x-www-form-urlencoded" \
         -d "baseCurrencyCode=USD" -d "targetCurrencyCode=EUR" -d "rate=0.92"
    ```
- **Обновить существующий курс:**
    ```sh
    curl -X PATCH http://localhost:8000/exchangeRate/USDRUB \
         -H "Content-Type: application/x-www-form-urlencoded" \
         -d "rate=91.50"
    ```

### Конвертация
* **Рассчитать обмен (100 USD в RUB):**
    ```sh
    curl -X GET "http://localhost:8000/exchange?from=USD&to=RUB&amount=100"
    ```

---

## Обработка ошибок

В случае некорректного запроса API возвращает стандартизированный JSON-объект. Поле message содержит детализированное описание причины отказа (например, указание на дублирование уникального кода или отсутствие записи в базе).

Примеры:

```json
{
  "message": "..."
}
```

HTTP-коды:

`400` — неверные параметры запроса
`404` — ресурс или курс не найден
`409` — конфликт уникальности
`500` — внутренняя ошибка сервера

---

## Используемые технологии

- Python 3.11+
- SQLite для хранения данных
- http.server для обработки HTTP-запросов
- JSON для обмена данными
- Паттерн MVC для структурирования кода

---

## Установка

Клонируйте репозиторий:

```sh
git clone https://github.com/ikorepanov/currency-exchange.git
cd currency-exchange
```

Убедитесь, что установлен `uv` и синхронизируйте зависимости:

```sh
uv sync
```

В случае необходимости, ВО может быть создано с помощью следующей команды:

```sh
uv venv
```

---

## Конфигурация БД

Первичная инициализация: для создания схемы таблиц и импорта демонстрационного набора данных из CSV-источников выполните:

```sh
python -m currency_exchange.db.create_db
```

В результате, в директории `currency_exchange/db` будет создан файл `db.sqlite`

Исходники (файлы csv) располагаются в `currency_exchange/db/data`

---

## Запуск сервера:

```sh
python -m currency_exchange.main
```

Сервер будет доступен по адресу http://localhost:8000

---

## Деплой:

Проект развёрнут на удалённом сервере и доступен по адресу `http://89.111.174.121:8000/`
